<!DOCTYPE html>
<html>
    <head>
        <title>Sentral 2 - Explore</title>
        
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

        <!--     Fonts and icons     -->
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
        <!-- Material Kit CSS -->
        <link href="assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
        
        <!-- <link rel="icon" href="static/tabicon"> -->
        <link rel="stylesheet" href="static/mainstyle.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

        <script type="text/javascript">
            class tag
            {
                static tags = [];
                static htmlBegin = String.raw
                `
                <button class="btn btn-warning btn-sm" onclick="
                `;
                static htmlCenter = String.raw
                `
                ">
                `;
                static htmlEnd = String.raw
                `
                &nbsp<i class="material-icons">close</i></button>
                `;
            }
            class questionSort
            {
                static type = 'new';
            }

            function addTag(tagStr)
            {
                if (!tag.tags.includes(tagStr))
                {
                    tag.tags.push(tagStr);
                    updateTags();
                }
            }
            function removeTag(tagStr)
            {
                tag.tags = tag.tags.filter(item => item !== tagStr);
                updateTags();
            }
            function updateTags()
            {
                let e = document.getElementById('tags-html');
                e.innerHTML = '';
                tag.tags.forEach(item => {
                    e.innerHTML += tag.htmlBegin + `removeTag(\'${item}\')` + tag.htmlCenter + item + tag.htmlEnd; 
                });
            }
            function searchForQuestions()
            {
                fetch("http://sentral2.ddns.net/database.json", {
                    method: "POST",
                    body: "weed",
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                });

                const a = require('fs');
                var xmlhttp;
                if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                    xmlhttp = new XMLHttpRequest();
                }
                else { // code for IE6, IE5
                    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                }
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        let parsedData = JSON.parse(xmlhttp.responseText);
                        console.log(parsedData);

                        if (questionSort.type === 'new')
                        {
                            parsedData.sort((a, b) => {
                                if (Date.parse(a) === Date.parse(b))
                                    return 0;
                                else if (Date.parse(a) > Date.parse(b))
                                    return 1;
                                else return -1;
                            });
                        }
                        else if (questionSort.type === 'popular')
                        {
                            parsedData.sort((a, b) => {
                                if (a.rating === b.rating)
                                    return 0;
                                else if (a.rating > b.rating)
                                    return -1;
                                else return 1;
                            });
                        }

                        let e = document.getElementById('search-input');

                        console.log(e.value);
                        parsedData = parsedData.filter(item => {
                            return item.question_text.toLowerCase().includes(e.value.toLowerCase()) && tag.tags.every(i => item.tags.includes(i.toLowerCase()));
                        });
                        parsedData = parsedData.slice(0, 10);

                        var cards = '';
                        parsedData.forEach(element => {
                            var tags = ''
                            element.tags.forEach(item => {
                                tags += `<a href="#"><button class="btn btn-info btn-sm">${item}</button></a>`
                            });

                            cards += String.raw
                            `
                            <div class="question-card"><div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><a href="#">${element.question_text}</a></h3>
                                    <p class="category">
                                        <p></p>
                                        Subject:
                                        <a href="#"><button class="btn btn-warning btn-sm">TODO: Implement this.</button></a>
                                        <br>Tags:
                                        ${tags}
                                    </p>
                                </div>
                                <div class="card-body">
                                    Asked By: ${element.author} | At: ${element.date_time.replace('T', ' ').replace('Z', '')} | Rating: ${element.rating}
                                </div>
                            </div></div>
                            `;
                        });
                        document.getElementById('question-cards').innerHTML = cards;
                    }
                }
                xmlhttp.open("GET", "database.json", true);
                xmlhttp.send();
            }
        </script>
    </head>


    <body onload="searchForQuestions()">

        <div class="sidebar">
            <div class="logo"><img src="static/logo.png"></div>
            <p></p>
            <p><a href="index.html"><button class="btn btn-default btn-lg btn-link fit"><i class="material-icons">home</i> Home</button></a></p>
            <p><a href="explore.html"><button class="btn btn-default btn-lg btn-link fit"><i class="material-icons">search</i> Explore</button></a></p>
            <p><a href="help.html"><button class="btn btn-default btn-lg btn-link fit"><i class="material-icons">help</i> Help</button></a></p>
            <p><a href="About us .html"><button class="btn btn-default btn-lg btn-link fit"><i class="material-icons">group</i> About us</button></a></p>

        </div>

        <div class="content">

            <h1>Sentral 2 - Explore</h1>
            <br>

            <form class="search-box" onsubmit="searchForQuestions()">
                <input id="search-input" type="text" placeholder="Search..." name="search">
            </form>

            <form onsubmit="let t = document.getElementById('tag-input').value; if (t !== '') addTag(t); return false;">
                <button class="btn btn-primary">
                    <i class="material-icons">add</i> 
                    &nbspAdd Tag&nbsp&nbsp
                </button>
                <input style="padding: 4px;", id="tag-input", type="text" placeholder="Tag..." name="tag">
                <button class="btn btn-success right-align" onclick="searchForQuestions()">
                    <i class="material-icons">search</i>
                </button>
            </form>

            <div id="tags-html">
            </div>
            
            <br><br>

            <button class="btn btn-secondary" onclick="questionSort.type = 'new'; searchForQuestions();">New</button>
            <button class="btn btn-secondary" onclick="questionSort.type = 'popular'; searchForQuestions();">Most Popular</button>
            
            <div class="cards"><div class="row" id="question-cards">
                
            </div></div>

        </div>

    </body>
</html>
